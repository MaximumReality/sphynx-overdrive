<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sphynx Overdrive: Maximum Reality</title>
<link rel="manifest" href="/sphynx-overdrive/manifest.json">
<style>
    body { background: #000; margin: 0; overflow: hidden; font-family: 'Courier New', monospace; touch-action: none; display: flex; justify-content: center; align-items: center; height: 100vh; }
    #game-container { position: relative; width: 400px; height: 600px; background: #050505; border: 4px solid #ff00ff; box-shadow: 0 0 20px #ff00ff; overflow: hidden; display: none; }
    canvas { position: absolute; top: 0; left: 0; transition: filter 0.1s; }
    #ui { position: absolute; width: 100%; display: flex; justify-content: space-between; padding: 10px; color: #00ffff; text-shadow: 0 0 5px #00ffff; z-index: 10; box-sizing: border-box; pointer-events: none; }
    #sound-toggle { position: absolute; bottom: 10px; left: 10px; z-index: 100; font-size: 24px; cursor: pointer; background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; border: 1px solid #00ffff; }
    #game-over { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #ff00ff; z-index: 20; background: rgba(0,0,0,0.9); padding: 20px; border: 2px solid #00ffff; min-width: 250px; }
    button { background: #00ffff; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; margin-top: 15px; }
    .crt-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%), linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03)); background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 5; }
    #splash-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; color: #0f0; padding: 20px; box-sizing: border-box; z-index: 9999; display: flex; flex-direction: column; }
    #terminal-output { white-space: pre-wrap; flex-grow: 1; overflow: hidden; font-size: 14px; line-height: 1.4; }
    #loading-bar-container { width: 100%; height: 4px; background: #002200; margin-top: 10px; }
    #loading-bar { width: 0%; height: 100%; background: #0f0; transition: width 0.2s; }
    #credibility-badge { position: fixed; bottom: 20px; right: 20px; width: 80px; z-index: 10000; opacity: 0.85; mix-blend-mode: screen; pointer-events: none; animation: glitch 1.5s infinite; }
    @keyframes glitch { 0% { transform: translate(0,0); filter: hue-rotate(0deg); } 20% { transform: translate(-2px,1px); filter: hue-rotate(20deg); } 100% { transform: translate(0,0); filter: hue-rotate(0deg); } }
    .pulse { transform: scale(1.3); transition: transform 0.1s ease; }
    .damage-flash { filter: invert(30%) sepia(100%) saturate(1000%) hue-rotate(320deg) brightness(100%) contrast(100%) !important; }
</style>
</head>
<body>

<div id="splash-screen">
    <div id="terminal-output"></div>
    <div id="loading-bar-container"><div id="loading-bar"></div></div>
</div>

<div id="game-container">
    <div id="sound-toggle" onclick="toggleSound()">üîá</div>
    <canvas id="bgCanvas"></canvas>
    <canvas id="gameCanvas"></canvas>
    <canvas id="particleCanvas"></canvas>
    <div id="ui"><div id="score">DATA: 0kb</div><div id="lives">NODES: 3</div></div>
    <div class="crt-overlay"></div>
    <div id="game-over">
        <h1>SYSTEM CRASHED</h1>
        <div id="final-stats" style="color: #00ffff; margin-bottom: 10px; font-size: 14px;"></div>
        <button onclick="resetGame()">REBOOT</button>
    </div>
</div>

<img id="credibility-badge" src="credibility_badge.png" alt="Trusted Badge">

<script>
// --- AUDIO ENGINE ---
let audioCtx, isMuted = true;
function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playBeep(f, d) { if (isMuted || !audioCtx) return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.type='square'; o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+d); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d); }
function toggleSound() { initAudio(); isMuted = !isMuted; document.getElementById('sound-toggle').innerText = isMuted ? 'üîá' : 'üîä'; if(!isMuted) playBeep(440, 0.1); }

// --- GAME GLOBALS ---
const W = 400, H = 600;
const bgCanvas = document.getElementById('bgCanvas'), bctx = bgCanvas.getContext('2d');
const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
const pCanvas = document.getElementById('particleCanvas'), pctx = pCanvas.getContext('2d');
bgCanvas.width = canvas.width = pCanvas.width = W; bgCanvas.height = canvas.height = pCanvas.height = H;

let score = 0, lives = 3, frame = 0, gameActive = true, screenShake = 0;
let highScore = localStorage.getItem('sphynxHighScore') || 0;
let currentLevel = 1;
const levelColors = ['#050505', '#00051a', '#1a001a', '#0a1a00', '#1a0a00'];

let obstacles = [], buildings = [], butterflies = [], cakes = [];
const cat = { x: 180, y: 520, w: 40, h: 40 };
const mochkil = { x: -50, y: 450, speed: 2, dir: 1 };

const azulImg = new Image(); azulImg.src = 'flyazulo.png';
const mochNormal = new Image(); mochNormal.src = 'mochkil_front_kart.png';
const mochSnack = new Image(); mochSnack.src = 'mochkil_walk_right_cake.png';
const firewallImg = new Image(); firewallImg.src = 'firewall.png';

// --- CLASSES ---
class Building {
    constructor(x) { this.x=x; this.w=Math.random()*60+40; this.h=Math.random()*200+100; this.y=Math.random()*H; this.speed=0.5; this.color=`hsl(280,100%,${Math.random()*10+2}%)`; }
    update(s){ this.y += s*this.speed; if(this.y>H){ this.y=-this.h; this.x=Math.random()*W; } }
    draw(){ bctx.fillStyle=this.color; bctx.fillRect(this.x,this.y,this.w,this.h); bctx.strokeStyle='#ff00ff22'; bctx.strokeRect(this.x,this.y,this.w,this.h); }
}
class Butterfly {
    constructor(){ this.x=Math.random()*W; this.y=Math.random()*H; this.vx=Math.random()*2-1; this.vy=Math.random()*2-1; }
    update(){ this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>W)this.vx*=-1; if(this.y<0||this.y>H)this.vy*=-1; }
    draw(){ pctx.fillStyle='#00ffff44'; pctx.beginPath(); pctx.arc(this.x,this.y,2,0,Math.PI*2); pctx.fill(); }
}

function update(){
    if(!gameActive) return;

    // --- LEVEL & BACKGROUND ---
    let newLevel = Math.floor(score / 500) + 1;
    if (newLevel > currentLevel) {
        currentLevel = newLevel;
        screenShake = 30;
        playBeep(220, 0.4);
        const alert = document.createElement('div');
        alert.innerHTML = `SYSTEM EVOLVED: LEVEL ${currentLevel}`;
        alert.style = "position:absolute; top:40%; width:100%; text-align:center; color:#0f0; font-weight:bold; font-size:24px; text-shadow:0 0 10px #0f0; z-index:100;";
        document.getElementById('game-container').appendChild(alert);
        setTimeout(() => alert.remove(), 2000);
    }
    bctx.fillStyle = levelColors[(currentLevel - 1) % levelColors.length];
    bctx.fillRect(0,0,W,H);
    buildings.forEach(b=>{ b.update(2+score/100); b.draw(); });

    // --- MAIN RENDER ---
    ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,W,H); 
    if(screenShake>0){ ctx.translate(Math.random()*screenShake-screenShake/2, Math.random()*screenShake-screenShake/2); screenShake*=0.9; }
    
    ctx.drawImage(azulImg,50,50,100,40);

    // --- MOCHKIL BOSS ---
    mochkil.x += mochkil.speed * mochkil.dir;
    if (mochkil.x > W + 50 || mochkil.x < -100) mochkil.dir *= -1;
    ctx.drawImage(mochSnack, mochkil.x, mochkil.y, 45, 45);
    if (frame % 150 === 0) {
        cakes.push({ x: mochkil.x + 20, y: mochkil.y, speed: 4 + (currentLevel * 0.5) });
    }

    // --- PLAYER ---
    ctx.font='40px serif'; ctx.shadowBlur=15; ctx.shadowColor='#00ffff'; ctx.fillText('üêà‚Äç‚¨õ',cat.x,cat.y+35); ctx.shadowBlur=0;

    // --- CAKES ---
    cakes.forEach((cake, idx) => {
        cake.y += cake.speed;
        ctx.font = '30px serif'; ctx.shadowBlur = 15; ctx.shadowColor = '#ff66cc';
        ctx.fillText('üç∞', cake.x, cake.y); ctx.shadowBlur = 0;
        if (cat.x < cake.x + 30 && cat.x + 40 > cake.x && cat.y < cake.y + 30 && cat.y + 40 > cake.y) {
            score += 50; pulseBadge(); screenShake = 10; cakes.splice(idx, 1);
            playBeep(1200, 0.05);
            document.getElementById('score').innerText=`DATA: ${score}kb`;
        }
        if (cake.y > H) cakes.splice(idx, 1);
    });

    // --- OBSTACLES ---
    if(frame % Math.max(20, 60 - currentLevel * 5) === 0) {
        obstacles.push({ x:Math.random()*(W-40), y:-50, type:Math.random()>0.3?'firewall':'data', speed:3+score/100 + (currentLevel*0.5) });
    }
    
    obstacles.forEach((o,i)=>{
        o.y+=o.speed;
        if(o.type==='data'){
            ctx.font='30px serif'; ctx.shadowBlur=15; ctx.shadowColor='#00ff00'; ctx.fillText('üíæ', o.x, o.y+25); ctx.shadowBlur=0;
        } else {
            ctx.shadowBlur=10; ctx.shadowColor='#ff0055'; ctx.drawImage(firewallImg, o.x, o.y, 60, 30); ctx.shadowBlur=0;
        }
        let hitW = o.type==='firewall' ? 60 : 30;
        if(cat.x < o.x + hitW && cat.x + 40 > o.x && cat.y < o.y + 30 && cat.y + 40 > o.y){
            if(o.type==='firewall'){
                lives--; screenShake=20; playBeep(110, 0.2); triggerDamage();
                if(lives<=0){ 
                    gameActive=false; 
                    if(score > highScore) { highScore = score; localStorage.setItem('sphynxHighScore', highScore); }
                    document.getElementById('game-over').style.display='block'; 
                    document.getElementById('final-stats').innerHTML = `SESSION DATA: ${score}kb<br>SYSTEM RECORD: ${highScore}kb`;
                }
            } else {
                score+=10; pulseBadge(); screenShake=5; playBeep(880, 0.05);
            }
            obstacles.splice(i,1);
            document.getElementById('score').innerText=`DATA: ${score}kb`; document.getElementById('lives').innerText=`NODES: ${lives}`;
        }
        if(o.y>H) obstacles.splice(i,1);
    });

    pctx.clearRect(0,0,W,H); butterflies.forEach(b=>{ b.update(); b.draw(); });
    frame++; requestAnimationFrame(update);
}

function triggerDamage() { canvas.classList.add('damage-flash'); setTimeout(() => canvas.classList.remove('damage-flash'), 150); }
function moveCat(x){ cat.x = Math.min(Math.max(x,0),W-cat.w); }
window.addEventListener('mousemove', e=>{ const rect = canvas.getBoundingClientRect(); moveCat(e.clientX-rect.left-20); });
window.addEventListener('touchmove', e=>{ const rect = canvas.getBoundingClientRect(); moveCat(e.touches[0].clientX-rect.left-20); e.preventDefault(); },{passive:false});
function resetGame(){ score=0; lives=3; currentLevel=1; obstacles=[]; cakes=[]; gameActive=true; document.getElementById('game-over').style.display='none'; document.getElementById('score').innerText='DATA: 0kb'; document.getElementById('lives').innerText='NODES: 3'; update(); }
function pulseBadge(){ const b=document.getElementById('credibility-badge'); b.classList.add('pulse'); setTimeout(()=>b.classList.remove('pulse'),100); }

// --- BOOT SEQUENCE ---
const output = document.getElementById('terminal-output');
const bar = document.getElementById('loading-bar');
const messages = [
    "> INITIALIZING MAXIMUM REALITY...",
    "> BYPASSING FIREWALL NODES...",
    "> LOCATING MOCHKIL_CAKE_CACHE...",
    "> ARCHITECT: MAXIMUM REALITY (YOU)",
    "> SYSTEM RECORD: " + highScore + "kb",
    "> DEPLOYING SPHYNX OVERDRIVE..."
];
let msgIndex = 0;
function typeBoot() {
    if(msgIndex < messages.length){
        output.innerText += messages[msgIndex] + "\n";
        msgIndex++; bar.style.width = (msgIndex/messages.length)*100 + "%";
        setTimeout(typeBoot, 400);
    } else { setTimeout(launch, 500); }
}
function launch(){
    document.getElementById('splash-screen').style.display='none';
    document.getElementById('game-container').style.display='block';
    for(let i=0;i<10;i++) buildings.push(new Building(Math.random()*W));
    for(let i=0;i<30;i++) butterflies.push(new Butterfly());
    let loaded=0; const assets = [azulImg, mochNormal, mochSnack, firewallImg];
    assets.forEach(img=>{ if(img.complete){ loaded++; if(loaded===4) update(); } else { img.onload=img.onerror=()=>{ loaded++; if(loaded===4) update(); }; } });
}
typeBoot();
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sphynx-overdrive/sw.js'); }
</script>
</body>
</html>
